@using CourseMate.Models
@using CourseMate.Models.ViewModels
@model CommentViewModel

@{
    var comment = Model.Comment;
    var depth = Model.Depth;
    var replyCount = comment.Replies.Count;
}

<div class="comment @(depth > 0 ? "nested-comment" : "")">
    <div class="comment-header">
        <div class="user-avatar">
            @((comment.IsAnonymous ? "A" : comment.User?.FullName?[0].ToString() ?? "U"))
        </div>
        <div class="comment-meta">
            <div class="username">@(comment.IsAnonymous ? "Anonymous" : comment.User?.FullName ?? "Unknown User")</div>
            <div class="datetime">@comment.CreatedAt.ToString("g")</div>
        </div>

        <!-- 3-dot menu -->
        <div class="comment-menu">
            <button class="menu-btn" onclick="toggleMenu('@comment.Id')">⋮</button>
            <div class="menu-dropdown" id="menu-@comment.Id">
                <button onclick="toggleReportForm('@comment.Id')">Report</button>
            </div>
        </div>
    </div>

    <div class="comment-content">
        @comment.Content
    </div>

    <div class="comment-actions">
        <button class="action-btn" onclick="toggleReplyForm('@comment.Id')">
            <i>↩</i> Reply
        </button>

        <div class="vote-count-comment">
            <form asp-controller="Vote" asp-action="Vote" method="post" style="display: inline;">
                <input type="hidden" name="id" value="@comment.Id" />
                <input type="hidden" name="votableType" value="Comment" />
                <button type="submit" name="value" value="1" 
                    class="vote-arrow @(Model.CurrentUserVote == 1 ? "upvoted" : "")"
                    @(comment.UserId == Model.CurrentUserId ? "disabled" : "")>↑</button>
            </form>
            <span>@comment.Upvotes</span>

            <form asp-controller="Vote" asp-action="Vote" method="post" style="display: inline;">
                <input type="hidden" name="id" value="@comment.Id" />
                <input type="hidden" name="votableType" value="Comment" />
                <button type="submit" name="value" value="-1" 
                    class="vote-arrow @(Model.CurrentUserVote == -1 ? "downvoted" : "")"
                    @(comment.UserId == Model.CurrentUserId ? "disabled" : "")>↓</button>
            </form>
            <span>@comment.Downvotes</span>
        </div>
    </div>

    <!-- Reply Form (initially hidden) -->
    <div class="reply-form" id="reply-form-@comment.Id" style="display:none;">
        <form asp-action="AddComment" method="post">
            <input type="hidden" name="postId" value="@Model.PostId" />
            <input type="hidden" name="parentId" value="@comment.Id" />
            <textarea name="content" required placeholder="Write your reply here..."></textarea>
            <div class="form-actions">
                @* <div class="anonymous-checkbox">
                    <input type="checkbox" id="IsAnonymous@(comment.Id)" name="isAnonymous" />
                    <label for="IsAnonymous@(comment.Id)">Post as Anonymous</label>
                </div> *@
                <button type="submit" class="btn-submit">Post Reply</button>
            </div>
        </form>
    </div>

    <!-- Report Form (initially hidden) -->
    <div class="report-form" id="report-form-@comment.Id" style="display:none;">
        <form asp-controller="Post" asp-action="ReportComment" method="post">
            <input type="hidden" name="commentId" value="@comment.Id" />
            <textarea name="reason" required placeholder="Why are you reporting this comment?"></textarea>
            <div class="form-actions">
                <button type="submit" class="btn-submit">Submit Report</button>
                <button type="button" class="btn-cancel" onclick="toggleReportForm('@comment.Id')">Cancel</button>
            </div>
        </form>
    </div>

    <!-- Replies -->
    @if (comment.Replies.Any())
    {
        <button class="comment-collapse-btn" onclick="toggleReplies(this, '@comment.Id')" data-reply-count="@replyCount">
            <span>Hide replies (@replyCount)</span>
        </button>

        <div class="comment-replies" id="replies-@comment.Id">
            @foreach (var reply in comment.Replies)
            {
                @await Html.PartialAsync("_Comment", new CommentViewModel {
                    Comment = reply,
                    CurrentUserId = Model.CurrentUserId,
                    PostId = Model.PostId,
                    Depth = depth + 1
                })
            }
        </div>
    }
</div>

<style>
    .comment-menu {
        margin-left: auto;
        position: relative;
    }
    .menu-btn {
        background: none;
        border: none;
        color: #aaa;
        font-size: 18px;
        cursor: pointer;
    }
    .menu-btn:hover {
        color: #fff;
    }
    .menu-dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: #222;
        border: 1px solid #444;
        border-radius: 6px;
        z-index: 10;
    }
    .menu-dropdown button {
        background: none;
        border: none;
        color: #ddd;
        padding: 8px 12px;
        width: 100%;
        text-align: left;
        cursor: pointer;
    }
    .menu-dropdown button:hover {
        background: #333;
    }
    .report-form textarea {
        width: 100%;
        margin: 8px 0;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #444;
        background: #111;
        color: #eee;
    }
    .report-form .form-actions {
        display: flex;
        gap: 10px;
    }
</style>

<script>
    function toggleMenu(commentId) {
        const menu = document.getElementById("menu-" + commentId);
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function toggleReportForm(commentId) {
        const form = document.getElementById("report-form-" + commentId);
        form.style.display = form.style.display === "block" ? "none" : "block";
        document.getElementById("menu-" + commentId).style.display = "none"; // hide menu after clicking
    }
</script>
